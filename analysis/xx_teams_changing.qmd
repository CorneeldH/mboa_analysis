---
title: "Kort verzuim"
---

## Inladen teams


```{r}

source("utils/dev_functions.R")
source("utils/manage_packages.R")

load_all()

```

```{r}


teams_selected_file_path <- file.path(config::get("data_analysed_dir"), "teams_selected.rds")

teams_selected <- readRDS(teams_selected_file_path)



team_namen <- teams_selected |> group_by(TEAM_naam, TEAM_naam_afk, team_label) |>
    summarize(
        # First create a group number
        team_number = cur_group_id(),
        # Then create labels using the group number
        team_label = paste("Team", LETTERS[team_number]),
        TEAM_aantal_eerstejaars = mean(TEAM_aantal_eerstejaars, na.rm = TRUE))

```

Mooi voorbeeld
- AELT

```{r}
variables_job <- c(
    "JOB_algemene_tevredenheid_opleiding",
    "JOB_sfeer_opleiding",
    "JOB_hulp_bij_presteren",
    "JOB_luistert_naar_mening")

variables_mto <- c(
    "MTO_ik_doe_graag_iets_extra_voor_mboa",
    "MTO_aandacht_persoonlijke_ontwikkeling",
    "MTO_mogelijkheid_tot_doorgroeien",
    #"MTO_vertrouwen_in_cvb",
    "MTO_jaarlijkse_gesprekken_leidinggevende",
    "MTO_open_communicatie_management",
    "MTO_leidinggevende_motiveert",
    "MTO_goede_samenwerking_binnen_team",
    #"MTO_waardering_door_mboa",
    #"MTO_ik_pas_bij_mboa",
    "MTO_ik_doe_waar_ik_goed_in_ben",
    #"MTO_waardering_door_leidinggevende",
    "MTO_werkdrukbeleving_bespreken_leidinggevende",
    "MTO_ik_wil_me_verbeteren")

goed_aelt <- teams_selected |> 
    filter(TEAM_naam_afk == "AELT") |> 
    select(
        TEAM_naam_afk,
        COHORT_naam,
        TEAM_startersresultaat_1_jaars,
        VERBINTENIS_waarneming_pct_aanwezig,
        VERBINTENIS_waarneming_pct_ongeoorloofd,
        MEDEWERKER_verzuim_pct_kort,
        MEDEWERKER_verzuim_pct_middellang,
        MEDEWERKER_verzuim_pct_lang,
        any_of(variables_mto),
        any_of(variables_job)
    )

slecht_abou <- teams_selected |> 
    filter(TEAM_naam_afk == "ABOU") |> 
    select(
        TEAM_naam_afk,
        COHORT_naam,
        TEAM_startersresultaat_1_jaars,
        VERBINTENIS_waarneming_pct_aanwezig,
        VERBINTENIS_waarneming_pct_ongeoorloofd,
        MEDEWERKER_verzuim_pct_kort,
        MEDEWERKER_verzuim_pct_middellang,
        MEDEWERKER_verzuim_pct_lang,
        any_of(variables_mto),
        any_of(variables_job)
    )

```


Good

Zien AOPT
Economie AECO2
MEI AELT

ATRC
ADETAIL

Bad

Hotelschool Amersfoort, AHHH
Kapperschool Amersfoort, AKAP
Bouwtechniek, ABOU

AAUD*
ACIO
AWEL
ATND


I'll help create the visualization. Since the teams data is across cohorts, and we need to show two metrics on different scales, here's the code:

To visualize just the TEAM_startersresultaat_1_jaars over the years per team:

To replace TEAM_naam_afk with Team A, B, etc. and remove 2019/2020, here's the code:

```{r}
teams_selected |>
    filter(COHORT_startjaar != 2019) |>
    group_by(TEAM_naam_afk) |>
    mutate(
        # First create a group number
        team_number = cur_group_id(),
        # Then create labels using the group number
        team_label = paste("Team", LETTERS[team_number])
    )|>
    ungroup() |>
    ggplot(aes(x = COHORT_naam, y = TEAM_startersresultaat_1_jaars / 100, group = TEAM_naam)) +
    geom_line(color = "#f49600") +
    geom_point(color = "#f49600") +
    geom_text(
        data = . %>%
            filter(
                team_label == "Team H" &
                    COHORT_naam %in% c("2020/2021", "2023/2024")
            ),
             
        aes(
            label = scales::percent(TEAM_startersresultaat_1_jaars / 10000, accuracy = 1),
             vjust = -0.5, show.legend = FALSE
        )
    ) +
    facet_wrap(~ team_label) +
    theme_pubclean() +
    
    theme(#axis.text.x = element_text(angle = 45, hjust = 1),
          #panel.grid.minor = element_blank(),
                  text = element_text(size = 12, family = "sans"),
        axis.text = element_text(size = 11, color = "grey"),
        axis.title = element_text(size = 12, face = "bold"),
        axis.text.x = element_text(angle = 45, hjust = 1),
        panel.grid.minor = element_blank(),
        panel.grid.major.x = element_blank(),
        panel.grid.major.y = element_line(),
        axis.ticks = element_blank(),
        strip.background = element_rect(fill = "#F8F9FA"),  # Light grey background
        strip.text = element_text(size = 12 #face = "bold"
                                  ),
        plot.background = element_rect(fill = "white")) +
    labs(x = "Cohort", y = "Startersresultaat (%)")
```

```{r}

teams_selected |>
    filter(COHORT_startjaar != 2019) |>
    group_by(TEAM_naam_afk) |>
    mutate(
        team_number = cur_group_id(),
        team_label = paste("Team", team_number)
    ) |>
    ungroup() |>
    ggplot(aes(x = COHORT_naam, y = TEAM_startersresultaat_1_jaars / 100, group = TEAM_naam)) +
    geom_line(linewidth = 1) +  # Slightly thicker lines for better visibility
    geom_point(size = 1) +        # Larger points
    facet_wrap(~ team_label) +
    theme_bw() +                  # White background with frame
    theme(axis.text.x = element_text(angle = 45, hjust = 1),
          panel.grid.minor = element_blank()
          ) +
    scale_y_continuous(
        labels = scales::percent,  # Format y-axis as percentages
        breaks = seq(0, 1, 0.2)    # Set breaks at 20% intervals
    ) +
    labs(
        x = "Cohort",
        y = "Startersresultaat (%)",
        title = "Startersresultaat per Team",  # Add a clear title
        subtitle = "Percentage per cohort"      # Add explanatory subtitle
    )

```

```{r}
ggplot(
    teams_selected, #|> filter(COHORT_startjaar %in% c(2020, 2022)),
    aes(x = COHORT_naam, y = TEAM_startersresultaat_1_jaars / 100, group = TEAM_naam)
) +
    geom_line(linewidth = 1) +
    geom_point() +
    facet_wrap( ~ TEAM_naam_afk) +
    theme_minimal() +
    theme(axis.text.x = element_text(angle = 45, hjust = 1),
          panel.grid.minor = element_blank()) +
    labs(x = "Cohort", y = "Startersresultaat (%)")


```


Here's the code for a double y-axis plot showing both TEAM_startersresultaat_1_jaars and MTO_aandacht_persoonlijke_ontwikkeling:

```{r}
teams_selected |>
    filter(COHORT_startjaar %in% c(2020, 2022),
           TEAM_naam_afk %in% c("AELT", "ABOU")) |>
    ggplot(aes(x = COHORT_naam)) +
    geom_line(aes(y = TEAM_startersresultaat_1_jaars/100, group = 1), color = "blue", linewidth = 1) +
    geom_point(aes(y = TEAM_startersresultaat_1_jaars/100), color = "blue") +
    geom_line(aes(y = MTO_aandacht_persoonlijke_ontwikkeling * 20, group = 1), color = "red", linewidth = 1) +
    geom_point(aes(y = MTO_aandacht_persoonlijke_ontwikkeling * 20, color = "red")) +
    scale_y_continuous(
        name = "Startersresultaat",
        sec.axis = sec_axis(~./20, name = "Persoonlijke ontwikkeling")
    ) +
    facet_wrap(~ TEAM_naam_afk) +
    theme_minimal() +
    theme(
        axis.text.x = element_text(angle = 45, hjust = 1),
        axis.title.y.left = element_text(color = "blue"),
        axis.title.y.right = element_text(color = "red"),
        panel.grid.minor = element_blank()
    )
```

Here's the code for a single plot with the specified colors and teams:

To fix the missing lines issue, we need to add a group aesthetic. Here's the corrected code:

```{r}
teams_selected |>
    filter(COHORT_startjaar %in% c(2020, 2022),
           TEAM_naam_afk %in% c("AELT", "ABOU")) |>
    ggplot(aes(x = COHORT_naam, color = TEAM_naam_afk)) +
    geom_line(aes(y = TEAM_startersresultaat_1_jaars/100, 
                  linetype = "Startersresultaat", 
                  group = interaction(TEAM_naam_afk, "Startersresultaat")), 
              linewidth = 1) +
    geom_point(aes(y = TEAM_startersresultaat_1_jaars/100)) +
    geom_line(aes(y = MTO_aandacht_persoonlijke_ontwikkeling * 20, 
                  linetype = "Persoonlijke ontwikkeling",
                  group = interaction(TEAM_naam_afk, "Persoonlijke ontwikkeling")), 
              alpha = 0.6) +
    geom_point(aes(y = MTO_aandacht_persoonlijke_ontwikkeling * 20), alpha = 0.6) +
    scale_color_manual(values = c("AELT" = "blue", "ABOU" = "red")) +
    scale_y_continuous(
        name = "Startersresultaat",
        sec.axis = sec_axis(~./20, name = "Persoonlijke ontwikkeling")
    ) +
    scale_linetype_manual(name = "Metric", values = c("dashed", "solid")) +
    theme_minimal() +
    theme(
        axis.text.x = element_text(angle = 45, hjust = 1),
        panel.grid.minor = element_blank()
    )
```


Here are two separate plots, one for each metric, using more neutral colors:

Here's how to add value labels to both plots:

```{r}
# Plot for Startersresultaat with labels
p1 <- teams_selected |>
    filter(COHORT_startjaar %in% c(2020, 2022),
           TEAM_naam_afk %in% c("AELT", "ABOU")) |>
    ggplot(aes(x = COHORT_naam, color = TEAM_naam_afk)) +
    geom_line(aes(y = TEAM_startersresultaat_1_jaars/100, 
                  group = TEAM_naam_afk), 
              linewidth = 1) +
    geom_point(aes(y = TEAM_startersresultaat_1_jaars/100)) +
    geom_text(aes(y = TEAM_startersresultaat_1_jaars/100,
                  label = round(TEAM_startersresultaat_1_jaars/100, 1)),
              vjust = -0.5, show.legend = FALSE) +
    scale_color_manual(values = c("AELT" = "#1f77b4", "ABOU" = "#ff7f0e")) +
    scale_y_continuous(limits = c(0, 100)) +
    labs(y = "Startersresultaat",
         x = "Cohort",
         color = "Team") +
    theme_minimal() +
    theme(axis.text.x = element_text(angle = 45, hjust = 1),
          panel.grid.minor = element_blank())

p1

# Plot for Persoonlijke Ontwikkeling with labels
p2 <- teams_selected |>
    filter(COHORT_startjaar %in% c(2020, 2022),
           TEAM_naam_afk %in% c("AELT", "ABOU")) |>
    ggplot(aes(x = COHORT_naam, color = TEAM_naam_afk)) +
    geom_line(aes(y = MTO_aandacht_persoonlijke_ontwikkeling,
                  group = TEAM_naam_afk),
              linewidth = 1) +
    geom_point(aes(y = MTO_aandacht_persoonlijke_ontwikkeling)) +
    geom_text(aes(y = MTO_aandacht_persoonlijke_ontwikkeling,
                  label = round(MTO_aandacht_persoonlijke_ontwikkeling, 1)),
              vjust = -0.5, show.legend = FALSE) +
    scale_color_manual(values = c("AELT" = "#1f77b4", "ABOU" = "#ff7f0e")) +
    scale_y_continuous(limits = c(1, 5)) +
    labs(y = "Persoonlijke Ontwikkeling (1 - 5)",
         x = "Cohort",
         color = "Team") +
    theme_minimal() +
    theme(axis.text.x = element_text(angle = 45, hjust = 1),
          panel.grid.minor = element_blank())

p2
```

```{r}
# Plot for Startersresultaat


p1 <- teams_selected |>
    filter(COHORT_startjaar %in% c(2020, 2022),
           TEAM_naam_afk %in% c("AELT", "ABOU")) |>
    ggplot(aes(x = COHORT_naam, color = TEAM_naam_afk)) +
    geom_line(aes(y = TEAM_startersresultaat_1_jaars/100, 
                  group = TEAM_naam_afk), 
              linewidth = 1) +
    geom_point(aes(y = TEAM_startersresultaat_1_jaars/100)) +
    scale_color_manual(values = c("AELT" = "#1f77b4", "ABOU" = "#ff7f0e")) +
    scale_y_continuous(limits = c(0, 100)) +
    labs(y = "Startersresultaat (%)",
         x = "Cohort",
         color = "Team") +
    theme_minimal() +
    theme(axis.text.x = element_text(angle = 45, hjust = 1),
          panel.grid.minor = element_blank())

# Plot for Persoonlijke Ontwikkeling
p2 <- teams_selected |>
    filter(COHORT_startjaar %in% c(2020, 2022),
           TEAM_naam_afk %in% c("AELT", "ABOU")) |>
    ggplot(aes(x = COHORT_naam, color = TEAM_naam_afk)) +
    geom_line(aes(y = MTO_aandacht_persoonlijke_ontwikkeling,
                  group = TEAM_naam_afk),
              linewidth = 1) +
    geom_point(aes(y = MTO_aandacht_persoonlijke_ontwikkeling)) +
    scale_color_manual(values = c("AELT" = "#1f77b4", "ABOU" = "#ff7f0e")) +
        scale_y_continuous(limits = c(1, 5)) +
    labs(y = "Persoonlijke Ontwikkeling (1 - 5)",
         x = "Cohort",
         color = "Team") +
    theme_minimal() +
    theme(axis.text.x = element_text(angle = 45, hjust = 1),
          panel.grid.minor = element_blank())

#library(patchwork)
p1
p2
```

```{r}
teams_selected |>
    filter(COHORT_startjaar %in% c(2020, 2022),
           TEAM_naam_afk %in% c("AELT", "ABOU")) |>
    ggplot(aes(x = COHORT_naam, y = MTO_aandacht_persoonlijke_ontwikkeling, group = TEAM_naam)) +
    geom_line(linewidth = 1) +
    geom_point() +
    facet_wrap(~ TEAM_naam_afk) +
    theme_minimal() +
    theme(axis.text.x = element_text(angle = 45, hjust = 1),
          panel.grid.minor = element_blank()) +
    labs(x = "Cohort", y = "Aandacht Persoonlijke Ontwikkeling")

```

